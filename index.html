<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <style>
      * {
        margin: 0;
        padding: 0;
      }
      #selected-loop {
        background-color: aqua;
      }
    </style>
  </head>
  <body>
    <div id="player"></div>
    <div id="controller">
      <div id="buttons">
        <button id="start-button">Start</button>
        <button id="end-button">End</button>
        <button id="reset-button">Reset</button>
      </div>
      <button id="clear-select-button">Clear Select</button>
      <ul id="loop-list"></ul>
    </div>
    <script>
      const tag = document.createElement("script");
      const videoId = new URL(location.href).searchParams.get("v");

      tag.src = "https://www.youtube.com/iframe_api";
      const firstScriptTag = document.getElementsByTagName("script")[0];
      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
      let player;
      function onYouTubeIframeAPIReady() {
        player = new YT.Player("player", {
          height: "360",
          width: "640",
          videoId: new URL(location.href).searchParams.get("v"),
        });
      }
      // end of yt load
      const startButton = document.getElementById("start-button");
      const endButton = document.getElementById("end-button");
      const resetButton = document.getElementById("reset-button");
      const clearSelectButton = document.getElementById("clear-select-button");
      const loopListElem = document.getElementById("loop-list");

      let loops = [];
      let selectedLoopId = null;
      let newLoopStart = null;

      updateButtons();

      startButton.addEventListener("click", () => {
        newLoopStart = player.getCurrentTime();
        updateButtons();
      });

      endButton.addEventListener("click", () => {
        isLoopMaking = false;
        const newLoopEnd = player.getCurrentTime();
        if (newLoopStart < newLoopEnd) {
          const id = Math.random();
          loops.push({
            id,
            range: [newLoopStart, newLoopEnd],
            name: `#${loops.length}`,
          });
          selectedLoopId = id;
          newLoopStart = null;
          updateButtons();
          updateLoopListElem();
        } else {
          alert("The end time of the loop is earlier than the start time.");
        }
      });

      resetButton.addEventListener("click", () => {
        newLoopStart = null;
        updateButtons();
      });

      clearSelectButton.addEventListener("click", () => {
        selectedLoopId = null;
        updateMark();
      });

      function updateButtons() {
        if (newLoopStart === null) {
          startButton.style.display = "unset";
          endButton.style.display = "none";
          resetButton.style.display = "none";
        } else if (newLoopStart !== null) {
          startButton.style.display = "none";
          endButton.style.display = "unset";
          resetButton.style.display = "unset";
        }
      }

      function updateLoopListElem() {
        const lis = [];
        for (const loop of loops) {
          const {
            id,
            name,
            range: [start, end],
          } = loop;
          const li = document.createElement("li");
          const text = document.createElement("div");
          text.innerHTML = `${name} <small>${toTimeStr(start)} ~ ${toTimeStr(
            end
          )}</small>`;
          const renameButton = document.createElement("button");
          renameButton.innerText = "rename";
          const deleteButton = document.createElement("button");
          deleteButton.innerText = "Delete";
          li.append(text, renameButton, deleteButton);
          li.addEventListener("click", () => {
            selectedLoopId = id;
            updateMark();
          });
          deleteButton.addEventListener("click", (event) => {
            event.stopPropagation();
            loops = loops.filter((loop) => loop.id !== id);
            if (id === selectedLoopId) {
              selectedLoopId = null;
            }
            updateLoopListElem();
          });
          renameButton.addEventListener("click", (event) => {
            event.stopPropagation();
            loop.name = prompt("New name?");
            updateLoopListElem();
          });
          lis.push(li);
        }
        while (loopListElem.firstChild) {
          loopListElem.removeChild(loopListElem.lastChild);
        }
        loopListElem.append(...lis);
        updateMark();
        function toTimeStr(time) {
          let timeArr = [];
          if (time > 3600) {
            timeArr.push(Math.floor(time / 3600));
          }
          if (time > 60) {
            const secondsInHour = time % 3600;
            timeArr.push(Math.floor(secondsInHour / 60));
          }
          timeArr.push((time % 60).toFixed(2));
          return timeArr.join(":");
        }
      }

      function updateMark() {
        const prevSelectedLoopElem = document.getElementById("selected-loop");
        if (prevSelectedLoopElem) {
          prevSelectedLoopElem.id = null;
        }
        const selectedLoopIndex = loops.findIndex(
          (loop) => loop.id === selectedLoopId
        );
        if (selectedLoopIndex > -1) {
          loopListElem.children[selectedLoopIndex].id = "selected-loop";
        }
      }

      setInterval(() => {
        if (
          player &&
          player.getPlayerState &&
          player.getPlayerState() === 1 &&
          selectedLoopId !== null
        ) {
          const curTime = player.getCurrentTime();
          const [start, end] = loops.find(
            (loop) => loop.id === selectedLoopId
          ).range;
          if (curTime < start || end < curTime) {
            player.seekTo(start);
          }
        }
      }, 50);
    </script>
  </body>
</html>
